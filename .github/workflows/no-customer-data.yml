name: Prevent Customer Data in PRs

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  detect-customer-data:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Scan diff for forbidden patterns
        run: |
          echo "üîç Scanning PR for customer data leakage..."

          # Add/remove patterns here as needed.
          # These are intentionally strict to fail early.
          PATTERNS=(
            "[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,6}"    # Email addresses
            "[0-9]{1,3}(\.[0-9]{1,3}){3}"                        # IPv4 addresses
            "[A-Fa-f0-9:]{2,}:[A-Fa-f0-9:]{2,}"                  # IPv6 addresses
            "([A-Za-z0-9-]+\.){1,}local"                         # internal DNS zones
            "hostname"                                           # common copy/paste error
            "internal"                                           # many companies use this tag
            "corp"                                               # corp.example.com
            "ad\."                                               # AD domains
            "dc[0-9]+"                                           # domain controllers
            "ML-[A-Za-z0-9]+"                                    # customer asset tags
            "C[0-9]{5,}"                                         # device IDs
          )

          # Get the PR diff
          DIFF="$(git diff origin/main)"

          FOUND=0
          for p in "${PATTERNS[@]}"; do
            if echo "$DIFF" | grep -E "$p" >/dev/null 2>&1; then
              echo "::error:: ‚ùå Detected customer data matching pattern: $p"
              FOUND=1
            fi
          done

          if [ $FOUND -eq 1 ]; then
            echo "‚ùå Customer data found. Failing workflow."
            exit 1
          fi

          echo "‚úÖ No customer data detected."
