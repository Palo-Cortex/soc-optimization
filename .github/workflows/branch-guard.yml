name: Enforce Branch Naming Convention

on:
  pull_request:
    types: [opened, edited, synchronize, reopened]

jobs:
  check-branch-name:
    # ⬇️ Skip this job when the source branch is main or develop
    if: >
      github.event.pull_request.head.ref != 'main' &&
      github.event.pull_request.head.ref != 'develop'
    runs-on: ubuntu-latest
    steps:
      - name: Get branch name
        id: branch
        run: |
          # For pull_request events, the source branch is in GITHUB_HEAD_REF
          echo "name=${GITHUB_HEAD_REF}" >> "$GITHUB_OUTPUT"

      - name: Validate branch name against convention
        run: |
          BRANCH_NAME="${{ steps.branch.outputs.name }}"

          echo "Branch name: $BRANCH_NAME"

          # Allowed kinds and areas
          REGEX='^(feat|fix|chore|refactor|docs|hotfix)\/(core|endpoint|email|identity|network|pov|tooling)-[a-z0-9-]+$'

          if [[ "$BRANCH_NAME" =~ $REGEX ]]; then
            echo "✅ Branch name matches required pattern."
            exit 0
          else
            echo "❌ Invalid branch name: $BRANCH_NAME"
            echo ""
            echo "Required pattern:"
            echo "  <kind>/<area>-<short-slug>"
            echo ""
            echo "Where:"
            echo "  kind  ∈  feat | fix | chore | refactor | docs | hotfix"
            echo "  area  ∈  core | endpoint | email | identity | network | pov | tooling"
            echo "  slug  ∈  lowercase letters, numbers, dashes (e.g. 'normalizer-file-artifacts')"
            echo ""
            echo "Examples:"
            echo "  feat/core-normalizer-file-artifacts"
            echo "  fix/endpoint-containment-timeout-bug"
            echo "  feat/pov-turla-carbon-scenario"
            exit 1
          fi
